name: CI/CD Deploy to EC2

on:
  push:
    branches: [ "master" ] # 본인의 메인 브랜치명 확인 (main 또는 master)
  workflow_dispatch:         # 수동 실행 버튼 추가

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. 빌드 작업 (JDK 17 + Maven)
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      # 2. 도커 이미지 빌드 및 Docker Hub 푸시
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        run: |
          docker build -t segovita/photogram:latest .
          docker push segovita/photogram:latest

      # 3. EC2 접속 및 배포 (SSH 사용)
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu # EC2 기본 유저명 (Amazon Linux는 ec2-user)
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # 1. 최신 이미지 받아오기
            docker pull segovita/photogram:latest
            
            # 2. 기존 컨테이너가 있다면 끄고 삭제
            docker stop photogram-container || true
            docker rm photogram-container || true
            
            # 3. 새 컨테이너 실행 (환경변수 싹 다 주입!)
            docker run -d -p 8080:8080 \
              --name photogram-container \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e RDS_HOST=${{ secrets.RDS_HOST }} \
              -e RDS_USERNAME=${{ secrets.RDS_USERNAME }} \
              -e RDS_PASSWORD=${{ secrets.RDS_PASSWORD }} \
              -e S3_BUCKET=${{ secrets.S3_BUCKET }} \
              -e AWS_REGION=ap-northeast-2 \
              -e FB_APP_ID=${{ secrets.FB_APP_ID }} \
              -e FB_APP_SECRET=${{ secrets.FB_APP_SECRET }} \
              segovita/photogram:latest
            
            # 4. 안 쓰는 (이름 없는) 이미지 싹 정리
            docker image prune -f